<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKI PMO Photo Booth</title>
    <!-- Include html2canvas Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #fffde7; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .booth-container {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* --- CAMERA SECTION --- */
        .camera-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 580px;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            margin-bottom: 15px;
            font-size: 14px;
            background-color: #f9f9f9;
        }

        .video-wrapper {
            position: relative;
            /* Match the aspect ratio of the final photo slot (550x412) */
            width: 550px;
            height: 412px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #eee;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures video fills the box without distortion */
            transform: scaleX(-1);
        }

        /* --- PREVIEW STRIP --- */
        #preview-strip {
            position: relative;
            width: 600px; 
            height: 1800px;
            background-color: white;
            /* Screen Preview Scaling */
            transform: scale(0.35); 
            transform-origin: top left;
            margin-bottom: -1100px; 
            margin-right: -350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        #photos-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 200px; 
            gap: 88px;          
        }

        .captured-photo {
            width: 550px;
            height: 412px;
            /* Crucial: ensures the image covers the slot cleanly */
            object-fit: cover; 
            transform: scaleX(-1);
            display: block;
        }

        #overlay-image {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* --- CONTROLS --- */
        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        
        button {
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        #start-btn { background-color: #e6007e; color: white; }
        #start-btn:hover { background-color: #c4006b; }

        #download-btn { background-color: #23a6d5; color: white; display: none; }
        #download-btn:hover { background-color: #1e8cb3; }

        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #countdown-display {
            font-size: 100px;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 0 15px rgba(0,0,0,0.9);
            display: none;
            z-index: 20;
        }
    </style>
</head>
<body>

    <h1>‚ú® MKI PMO Photo Booth ‚ú®</h1>

    <div class="booth-container">
        <div class="camera-section">
            <select id="camera-select">
                <option value="">Searching for cameras...</option>
            </select>

            <div class="video-wrapper">
                <video id="video" autoplay playsinline></video>
                <div id="countdown-display">3</div>
            </div>
            
            <div class="controls">
                <button id="start-btn" onclick="startPhotoSequence()">üì∏ Start Booth</button>
                <button id="download-btn" onclick="shareOrDownload()">‚¨áÔ∏è Download / AirDrop</button>
            </div>
        </div>

        <div id="preview-strip">
            <div id="photos-layer"></div>
            <!-- Ensure overlay.png exists -->
            <img src="overlay.png" id="overlay-image" alt="Overlay">
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const cameraSelect = document.getElementById('camera-select');
        const photosLayer = document.getElementById('photos-layer');
        const countdownDisplay = document.getElementById('countdown-display');
        const startBtn = document.getElementById('start-btn');
        const downloadBtn = document.getElementById('download-btn');
        const stripElement = document.getElementById('preview-strip');
        const shutterSound = new Audio('https://www.soundjay.com/mechanical/camera-shutter-click-08.mp3');

        let currentStream = null;

        // 1. Camera Setup
        async function getCameras() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                cameraSelect.innerHTML = '';
                videoDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${cameraSelect.length + 1}`;
                    cameraSelect.appendChild(option);
                });
                if (videoDevices.length > 0) startCamera(videoDevices[0].deviceId);
            } catch (err) {
                console.error(err);
                alert("Please allow camera permissions.");
            }
        }

        async function startCamera(deviceId) {
            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
            try {
                // We request a high resolution, but CSS handles the display size
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        deviceId: { exact: deviceId }, 
                        width: { ideal: 1920 }, 
                        height: { ideal: 1080 } 
                    }
                });
                currentStream = stream;
                video.srcObject = stream;
            } catch (err) { console.error(err); }
        }

        cameraSelect.addEventListener('change', (e) => startCamera(e.target.value));
        getCameras();

        // 2. Photo Sequence
        function startPhotoSequence() {
            photosLayer.innerHTML = ''; 
            startBtn.disabled = true;
            downloadBtn.style.display = 'none';
            
            let photosTaken = 0;

            function takeNextPhoto() {
                if (photosTaken >= 3) {
                    finishSequence();
                    return;
                }
                let count = 3;
                countdownDisplay.style.display = 'block';
                countdownDisplay.innerText = count;

                const timer = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownDisplay.innerText = count;
                    } else {
                        clearInterval(timer);
                        countdownDisplay.style.display = 'none';
                        capturePhoto();
                        photosTaken++;
                        setTimeout(takeNextPhoto, 1500);
                    }
                }, 1000);
            }
            takeNextPhoto();
        }

        function capturePhoto() {
            shutterSound.play();
            
            // Define the target size for the photo slot
            const targetWidth = 550;
            const targetHeight = 412;

            // Create canvas for cropping/sizing
            const canvas = document.createElement('canvas');
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            const ctx = canvas.getContext('2d');
            
            // Calculate Aspect Ratio Crop (Object-Fit: Cover logic)
            const videoRatio = video.videoWidth / video.videoHeight;
            const targetRatio = targetWidth / targetHeight;
            
            let drawWidth, drawHeight, startX, startY;

            if (videoRatio > targetRatio) {
                // Video is wider than slot: Crop sides
                drawHeight = targetHeight;
                drawWidth = video.videoWidth * (targetHeight / video.videoHeight);
                startX = (targetWidth - drawWidth) / 2;
                startY = 0;
            } else {
                // Video is taller than slot: Crop top/bottom
                drawWidth = targetWidth;
                drawHeight = video.videoHeight * (targetWidth / video.videoWidth);
                startX = 0;
                startY = (targetHeight - drawHeight) / 2;
            }

            // Draw to canvas with mirroring
            ctx.translate(targetWidth, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, startX, startY, drawWidth, drawHeight);
            
            // Convert to image
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.classList.add('captured-photo');
            photosLayer.appendChild(img);
        }

        function finishSequence() {
            startBtn.disabled = false;
            startBtn.innerText = "Retake";
            downloadBtn.style.display = 'block';
        }

        // 3. Download Logic
        function shareOrDownload() {
            // Reset transforms for full-quality capture
            const originalTransform = stripElement.style.transform;
            const originalMargin = stripElement.style.margin;
            stripElement.style.transform = "scale(1)";
            stripElement.style.margin = "0";

            html2canvas(stripElement, { 
                scale: 1, 
                useCORS: true, 
                allowTaint: true,
                backgroundColor: null,
                width: 600, // Explicitly set width
                height: 1800 // Explicitly set height
            }).then(canvas => {
                // Restore UI immediately
                stripElement.style.transform = originalTransform;
                stripElement.style.margin = originalMargin;

                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'MKI_PMO_Strip.png', { type: 'image/png' });

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'MKI PMO Photo Booth',
                                text: 'Here is your photo strip!'
                            });
                        } catch (err) {
                            console.log('Share canceled, downloading instead');
                            triggerDownload(blob);
                        }
                    } else {
                        triggerDownload(blob);
                    }
                }, 'image/png');

            }).catch(err => {
                console.error("Capture failed:", err);
                alert("Error generating image. Ensure you are running this on a server.");
                stripElement.style.transform = originalTransform;
                stripElement.style.margin = originalMargin;
            });
        }

        function triggerDownload(blob) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'MKI_PMO_Strip.png';
            link.click();
        }
    </script>
</body>
</html>